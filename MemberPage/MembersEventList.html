<!DOCTYPE html>
<html>

<head>
    <title>WCSS Tech Events</title>
    <link rel="stylesheet" href="/CSS/DarkStyle.css">
    <link rel="icon" type="image/x-icon" href="/FavIcon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            text-align: left;
        }
        
    </style>
</head>

<body>
    <div id="theme-switcher">
        <label class="switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider"></span>
        </label>
    </div>
    <div class="sidebar">
        <a href="MembersPage.html">Calendar</a>
        <a href="MembersEventlist.html">Event List</a>
        <a href="MembersHelpfulResources.html">Helpful Resources</a>
        <a href="MembersPageContacts.html">Contacts</a>
        <a href="/UserPage/UserPage.html">UserPage</a>
        <a href="/UserPage/UserPage.html" onclick="signOut()">Sign Out</a>
    </div>
    <div class="content">
        <h1>Upcoming Events</h1>
        <script>
            async function optIn(eventName) {
                try {
                    const response = await fetch('http://127.0.0.1:6421/opt-in', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include', // Include cookies in the request
                        body: JSON.stringify({ eventName })
                    });

                    if (response.ok) {
                        alert('Opt-in request sent successfully!');
                    } else {
                        const errorText = await response.text();
                        alert(`Failed to send opt-in request: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error during opt-in:', error);
                    alert('Failed to send opt-in request. Please try again.');
                }
            }

            async function fetchOptInStatus() {
                try {
                    const response = await fetch('http://127.0.0.1:6421/opt-in-status', {
                        credentials: 'include', // Include cookies in the request
                    });
                    if (response.ok) {
                        return await response.json();
                    } else {
                        console.error('Failed to fetch opt-in status');
                        return [];
                    }
                } catch (error) {
                    console.error('Error fetching opt-in status:', error);
                    return [];
                }
            }

            async function toggleOptIn(eventName, button) {
                const isCanceling = button.textContent === 'Cancel Request';

                try {
                    const endpoint = isCanceling ? '/cancel-opt-in' : '/opt-in';
                    const response = await fetch(`http://127.0.0.1:6421${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include', // Include cookies in the request
                        body: JSON.stringify({ eventName }),
                    });

                    if (response.ok) {
                        if (isCanceling) {
                            button.textContent = 'Opt into event';
                            button.disabled = false;
                            alert('Opt-in request canceled successfully!');
                        } else {
                            button.textContent = 'Cancel Request';
                            button.disabled = false;
                            alert('Opt-in request sent successfully!');
                        }
                    } else {
                        const errorText = await response.text();
                        alert(`Failed to process request: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error during opt-in toggle:', error);
                    alert('Failed to process request. Please try again.');
                } finally {
                    button.disabled = false; // Ensure the button is re-enabled after the request
                }
            }

            fetch('http://127.0.0.1:5500/api/events')
                .then(response => response.json())
                .then(async events => {
                    const optInStatus = await fetchOptInStatus();
                    const contentDiv = document.querySelector('.content');

                    // Remove old event containers if any
                    const oldList = document.getElementById('member-event-list');
                    if (oldList) oldList.remove();

                    // Create a new list
                    const eventList = document.createElement('ul');
                    eventList.id = 'member-event-list';
                    eventList.style.listStyle = 'none';
                    eventList.style.padding = '0';

                    events.forEach(event => {
                        const listItem = document.createElement('li');
                        listItem.style.background = '#181818';
                        listItem.style.border = '1px solid #333';
                        listItem.style.borderRadius = '8px';
                        listItem.style.marginBottom = '18px';
                        listItem.style.padding = '16px 18px 10px 18px';
                        listItem.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                        listItem.style.transition = 'background 0.2s';

                        listItem.innerHTML = `
                            <strong>${event.name}</strong><br>
                            Date: ${event.date}<br>
                            Location: ${event.location}<br>
                            Start Time: ${event.startTime}<br>
                            End Time: ${event.endTime}<br>
                            People: ${event.people}<br>
                            Volunteer Hours: ${event.volunteerHours}<br>
                        `;

                        // Create the opt-in button
                        const optInButton = document.createElement('button');
                        optInButton.style.marginTop = '8px';
                        optInButton.style.marginBottom = '16px';
                        optInButton.style.border = '1px solid black';
                        optInButton.style.backgroundColor = '#242424';

                        const userEvent = optInStatus.find(e => e.name === event.name);

                        if (userEvent) {
                            if (userEvent.status === 'requested') {
                                optInButton.textContent = 'Cancel Request';
                            } else if (userEvent.status === 'approved') {
                                optInButton.textContent = 'Opted In';
                                optInButton.disabled = true;
                            }
                        } else {
                            optInButton.textContent = 'Opt into event';
                        }

                        optInButton.addEventListener('click', async () => {
                            optInButton.disabled = true; // Prevent multiple clicks
                            await toggleOptIn(event.name, optInButton);
                        });

                        listItem.appendChild(document.createElement('br'));
                        listItem.appendChild(optInButton);
                        eventList.appendChild(listItem);
                    });

                    contentDiv.appendChild(eventList);
                })
                .catch(error => console.error('Error fetching events:', error));

            function loadOptInRequests() {
                console.log('Fetching opt-in requests...');
                fetch('http://127.0.0.1:6421/admin/opt-in-requests')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Opt-in requests:', data); // Debug log
                        const requestList = document.getElementById('approve-opt-in-list');
                        requestList.innerHTML = ''; // Clear the list

                        Object.entries(data).forEach(([userId, events]) => {
                            events.forEach(event => {
                                console.log('Processing event:', event); // Debug log
                                const listItem = document.createElement('li');
                                listItem.textContent = `${event.name} (User: ${userId}, Status: ${event.status})`;

                                if (event.status === 'requested') {
                                    // Approve button
                                    const approveButton = document.createElement('button');
                                    approveButton.textContent = 'Approve';
                                    approveButton.onclick = () => updateOptIn(userId, event.name, 'approve');

                                    // Deny button
                                    const denyButton = document.createElement('button');
                                    denyButton.textContent = 'Deny';
                                    denyButton.style.marginLeft = '10px';
                                    denyButton.onclick = () => updateOptIn(userId, event.name, 'deny');

                                    listItem.appendChild(approveButton);
                                    listItem.appendChild(denyButton);
                                } else if (event.status === 'denied') {
                                    // Opt-in again button
                                    const optInAgainButton = document.createElement('button');
                                    optInAgainButton.textContent = 'Opt-in Again';
                                    optInAgainButton.style.marginLeft = '10px';
                                    optInAgainButton.onclick = () => optInAgain(userId, event.name);

                                    listItem.appendChild(optInAgainButton);
                                }

                                requestList.appendChild(listItem);
                            });
                        });
                    })
                    .catch(error => console.error('Error loading opt-in requests:', error));
            }

            // Function to handle "Opt-in Again"
            function optInAgain(userId, eventName) {
                fetch('http://127.0.0.1:6421/opt-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventName }),
                })
                    .then(response => {
                        if (response.ok) {
                            alert('Opt-in request submitted again!');
                            loadOptInRequests(); // Reload the list
                        } else {
                            response.text().then(errorText => alert(`Failed to opt-in again: ${errorText}`));
                        }
                    })
                    .catch(error => console.error('Error opting in again:', error));
            }
        </script>
        <script src="/JS/authClient.js"></script> <!-- Include the authentication check script -->
        <script src="/JS/themeHandler.js"></script>
    </div>
</body>
</head>

</html>